import { FlexBox, FlexBubble, FlexComponent, FlexMessage, Message, TextMessage } from "@line/bot-sdk";
import { getDate, sliceByNumber } from "../utils/common";
import {
  replyMessagesBefore,
  replyMessagesAfter,
  ReplyMessage,
  Colors, MessageAssets, ButtonStylesByColor,
} from "../const/common";
import { ITodo, ITodoLines, IUser } from "../types";

export class LineMessageBuilder {
  static createRemindMessage(messageToken: string, userName: string, todo: ITodo, remindDays: number) {
    const relativeDays = LineMessageBuilder.relativeRemindDays(remindDays);
    const remindColor = LineMessageBuilder.getRemindColor(remindDays);
    const taskUrl = process.env.ENV === "local"
      ? todo.todoapp_reg_url
      : `${ process.env.HOST }/api/message/redirect/${ todo.id }/${ messageToken }`;
    const message: FlexMessage = {
      type: "flex",
      altText: `„Äå${ todo.name }„Äç„ÅÆÈÄ≤Êçó„ÅØ„ÅÑ„Åã„Åå„Åß„Åô„ÅãÔºü`,
      contents: {
        type: "bubble",
        body: {
          type: "box",
          layout: "vertical",
          contents: [
            {
              type: "text",
              text: todo.name,
              weight: "bold",
              size: "xl",
              wrap: true,
              action: {
                type: "uri",
                label: "action",
                uri: taskUrl,
              },
            },
            {
              type: "box",
              layout: "vertical",
              margin: "lg",
              spacing: "sm",
              contents: [
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "sm",
                  contents: [
                    { type: "text", text: "ÊúüÈôê", color: "#BDBDBD", size: "sm", flex: 1 },
                    {
                      type: "text",
                      wrap: true,
                      color: "#666666",
                      size: "md",
                      flex: 5,
                      contents: [
                        { type: "span", text: relativeDays, weight: "bold", color: remindColor },
                        { type: "span", text: `(${ getDate(todo.deadline) })`, size: "sm" },
                      ],
                    },
                  ],
                },
              ],
            },
          ],
        },
        footer: {
          type: "box",
          layout: "vertical",
          spacing: "md",
          contents: [],
          flex: 0,
        }
      },
    };

    const buttons: ReplyMessage[] = remindDays > 0 ? replyMessagesAfter : replyMessagesBefore;
    buttons.filter(b => b.primary).forEach(button => (message.contents as FlexBubble).footer?.contents.push({
      type: "button",
      style: ButtonStylesByColor[button.color],
      height: "md",
      action: {
        type: "postback",
        label: button.label,
        data: button.status,
        displayText: button.displayText,
      },
      color: Colors[button.color],
    }));
    const secondaryButtonContents: FlexBox[] = [];
    sliceByNumber(buttons.filter(b => !b.primary), 2).forEach(row => {
      const content: FlexBox = {
        type: "box",
        layout: "horizontal",
        contents: [],
        spacing: "md",
      };
      row.forEach(button => content.contents.push({
        type: "button",
        style: ButtonStylesByColor[button.color],
        height: "md",
        action: {
          type: "postback",
          label: button.label,
          data: button.status,
          displayText: button.displayText,
        },
        color: Colors[button.color],
      }));
      secondaryButtonContents.push(content);
    });
    (message.contents as FlexBubble).footer?.contents.push(...secondaryButtonContents);
    return message;
  }

  static createReplyDoneMessage(superior?: string): TextMessage {
    let text = "ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„Çì„Åß„Åô„Å≠üòå\n"
      + "„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ\n\n"
      + "ÊãÖÂΩì„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åôüòä";
    if (superior) {
      text += `\n\n${ superior }„Åï„Çì„Å´Â†±Âëä„Åó„Å¶„Åä„Åç„Åæ„Åô„Å≠üí™`;
    }
    return { type: "text", text };
  }

  static createReplyInProgressMessage(superior?: string): TextMessage {
    let text = "ÊâøÁü•„Åó„Åæ„Åó„Åüüëç\n";
    if (superior) {
      text += `${ superior }„Åï„Çì„Å´Â†±Âëä„Åó„Å¶„Åä„Åç„Åæ„Åô„Å≠üí™\n\n`;
    }
    text += "Âºï„ÅçÁ∂ö„Åç„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åôüí™";
    return { type: "text", text };
  }

  static createDelayReplyMessage(): TextMessage {
    const text = "ÊâøÁü•„Åó„Åæ„Åó„Åüüòñ\nÂºï„ÅçÁ∂ö„Åç„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åôüí™";
    return { type: "text", text };
  }

  static createProcessingJobReplyMessage(): TextMessage {
    const text = "Âá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇÂ∞ë„ÄÖ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ";
    return { type: "text", text };
  }

  static createWithdrawnReplyMessage(): TextMessage {
    const text = "„Åù„ÅÜ„Å™„Çì„Åß„Åô„Å≠ÔºÅÊâøÁü•„Åó„Åæ„Åó„Åüüòä";
    return { type: "text", text };
  }

  static createStartReportToSuperiorMessage(superior: string): TextMessage {
    const text = `${ superior }„Åï„Çì\n`
      + "„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åôüôå\n\n"
      + "„Çø„Çπ„ÇØ„ÅÆÈÄ≤Êçó„ÇíËÅû„ÅÑ„Å¶„Åç„Åü„ÅÆ„Åß„ÄÅ„ÅîÂ†±Âëä„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ";
    return { type: "text", text };
  }

  static createUnKnownMessage(): TextMessage {
    const text = "„É°„ÉÉ„Çª„Éº„Ç∏„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åôüòä\n\n"
      + "Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅ„Åì„Å°„Çâ„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„Åã„ÇâÂÄãÂà•„Å´Ëøî‰ø°„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åõ„Çì‚Ä¶\n"
      + "„Åæ„Åü‰Ωï„Åã„ÅÇ„Çä„Åæ„Åó„Åü„Çâ„ÅäÁü•„Çâ„Åõ„Åó„Åæ„Åô„Å≠üôå";
    return { type: "text", text };
  }

  static createStartRemindMessageToUser(user: IUser, todoLines: ITodoLines[], superior?: string) {
    const sortedTodoLines = todoLines.sort((a, b) => (a.remindDays < b.remindDays ? 1 : -1));

    const groupMessageMap = new Map<number, ITodoLines[]>();
    sortedTodoLines.forEach((item) => {
      if (groupMessageMap.has(item.remindDays)) {
        groupMessageMap.get(item.remindDays).push(item);
      } else {
        groupMessageMap.set(item.remindDays, [item]);
      }
    });

    let firstText = `${ user.name }„Åï„Çì„ÄÅ„ÅäÁñ≤„ÇåÊßò„Åß„ÅôÔºÅ\n„Çø„Çπ„ÇØ„ÅÆÈÄ≤Êçó„Çí„ÅäÂ∞ã„Å≠„Åó„Åæ„Åôüôá`;
    if (superior) {
      firstText += `\n„ÅäÁ≠î„Åà„ÅÑ„Åü„Å†„ÅÑ„ÅüÂÜÖÂÆπ„Çí${ superior }„Åï„Çì„Å´„Åä‰ºù„Åà„Åó„Åæ„ÅôÔºÅ`;
    }
    const messages: (TextMessage | FlexMessage)[] = [{
      type: "text",
      text: firstText,
    }];
    messages.push({
      type: "flex",
      altText: firstText,
      contents: {
        type: "bubble",
        body: {
          type: "box",
          layout: "vertical",
          contents: [],
          spacing: "xl",
        },
      },
    });

    groupMessageMap.forEach((targetDueTodos, remindDays) => {
      const relativeDays = LineMessageBuilder.relativeRemindDays(remindDays);
      const remindColor = LineMessageBuilder.getRemindColor(remindDays);
      const targetDueBlock: FlexBox = {
        type: "box",
        layout: "vertical",
        contents: [
          {
            type: "box",
            layout: "baseline",
            contents: [{
              type: "text",
              weight: "regular",
              size: "sm",
              wrap: true,
              contents: [
                { type: "span", text: relativeDays, weight: "bold", color: remindColor },
                { type: "span", text: `„ÅåÊúüÊó•„ÅÆ„Çø„Çπ„ÇØ: ${ targetDueTodos.length }‰ª∂` },
              ],
              color: "#757575",
            }],
            spacing: "xs",
          },
          { type: "box", layout: "vertical", contents: [] },
        ],
        spacing: "sm",
      };
      targetDueTodos.forEach(todoLine => {
        (targetDueBlock.contents[1] as FlexBox).contents.push({
          type: "box",
          layout: "baseline",
          spacing: "sm",
          contents: [
            { type: "icon", url: MessageAssets.CHECK, size: "sm" },
            { type: "text", text: todoLine.todo.name, wrap: false },
          ],
          action: { type: "uri", label: "„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞", uri: todoLine.todo.todoapp_reg_url },
        });
      });
      ((messages[1] as FlexMessage).contents as FlexBubble).body?.contents.push(targetDueBlock);
    });

    return messages;
  }

  static createListTaskMessageToAdmin(todos: ITodo[]): FlexMessage {
    const message: FlexMessage = {
      type: "flex",
      altText: `ÁèæÂú®„ÄÅ${ todos.length }‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÅÆÊãÖÂΩìËÄÖ„ÉªÊúüÊó•„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çìüò≠`,
      contents: {
        type: "bubble",
        body: {
          type: "box",
          layout: "vertical",
          contents: [
            {
              type: "box",
              layout: "baseline",
              contents: [
                { type: "icon", url: MessageAssets.ALERT, size: "xs" },
                {
                  type: "text",
                  weight: "regular",
                  size: "sm",
                  wrap: true,
                  contents: [
                    { type: "span", text: `${ todos.length }‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÅÆ` },
                    { type: "span", text: "ÊãÖÂΩìËÄÖ„ÉªÊúüÊó•", weight: "bold" },
                    { type: "span", text: "„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ" },
                  ],
                  color: Colors.alert,
                }
              ],
              spacing: "xs",
            },
            {
              type: "box",
              layout: "vertical",
              contents: [],
            }
          ],
          spacing: "sm"
        }
      },
    };
    todos.forEach(todo => ((message.contents as FlexBubble).body.contents[1] as FlexBox).contents.push({
      type: "box",
      layout: "baseline",
      spacing: "sm",
      contents: [
        { type: "icon", url: MessageAssets.CHECK, size: "sm" },
        { type: "text", text: todo.name, wrap: false },
      ],
      action: { type: "uri", label: "„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞", uri: todo.todoapp_reg_url },
    }));
    return message;
  }

  static createNotAssignListTaskMessageToAdmin(todos: ITodo[]): FlexMessage {
    const message: FlexMessage = {
      type: "flex",
      altText: `ÁèæÂú®„ÄÅ${ todos.length }‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÅÆÊãÖÂΩìËÄÖ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çìüò≠`,
      contents: {
        type: "bubble",
        body: {
          type: "box",
          layout: "vertical",
          contents: [
            {
              type: "box",
              layout: "baseline",
              contents: [
                { type: "icon", url: MessageAssets.ALERT, size: "xs" },
                {
                  type: "text",
                  weight: "regular",
                  size: "sm",
                  wrap: true,
                  contents: [
                    { type: "span", text: `${ todos.length }‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÅÆ` },
                    { type: "span", text: "ÊãÖÂΩìËÄÖ", weight: "bold" },
                    { type: "span", text: "„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ" },
                  ],
                  color: Colors.alert,
                }
              ],
              spacing: "xs",
            },
            {
              type: "box",
              layout: "vertical",
              contents: [],
            }
          ],
          spacing: "sm"
        }
      },
    };
    todos.forEach(todo => ((message.contents as FlexBubble).body.contents[1] as FlexBox).contents.push({
      type: "box",
      layout: "baseline",
      spacing: "sm",
      contents: [
        { type: "icon", url: MessageAssets.CHECK, size: "sm" },
        { type: "text", text: todo.name, wrap: false },
      ],
      action: { type: "uri", label: "„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞", uri: todo.todoapp_reg_url },
    }));
    return message;
  }

  static createListTaskMessageToUser(todos: ITodo[]): FlexMessage {
    const message: FlexMessage = {
      type: "flex",
      altText: `ÁèæÂú®„ÄÅ${ todos.length }‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÅÆÊúüÊó•„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çìüò≠`,
      contents: {
        type: "bubble",
        body: {
          type: "box",
          layout: "vertical",
          contents: [
            {
              type: "box",
              layout: "baseline",
              contents: [
                { type: "icon", url: MessageAssets.ALERT, size: "xs" },
                {
                  type: "text",
                  weight: "regular",
                  size: "sm",
                  wrap: true,
                  contents: [
                    { type: "span", text: `${ todos.length }‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÅÆ` },
                    { type: "span", text: "ÊúüÊó•", weight: "bold" },
                    { type: "span", text: "„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ" },
                  ],
                  color: Colors.alert,
                }
              ],
              spacing: "xs",
            },
            {
              type: "box",
              layout: "vertical",
              contents: [],
            }
          ],
          spacing: "sm"
        }
      },
    };
    todos.forEach(todo => ((message.contents as FlexBubble).body.contents[1] as FlexBox).contents.push({
      type: "box",
      layout: "baseline",
      spacing: "sm",
      contents: [
        { type: "icon", url: MessageAssets.CHECK, size: "sm" },
        { type: "text", text: todo.name, wrap: false },
      ],
      action: { type: "uri", label: "„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞", uri: todo.todoapp_reg_url },
    }));
    return message;
  }

  static createNoListTaskMessageToAdmin(adminUser: IUser): TextMessage {
    return {
      type: "text",
      text: `${ adminUser.name }„Åï„Çì\n`
        + "„ÅäÁñ≤„ÇåÊßò„Åß„Åôüôå\n\n"
        + "ÁèæÂú®„ÄÅÊ¨°„ÅÆ„Çø„Çπ„ÇØ„ÅÆÊãÖÂΩìËÄÖ„ÉªÊúüÊó•„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºÅ\n"
        + "Âºï„ÅçÁ∂ö„Åç„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôÔºÅ",
    };
  }

  static createReportToSuperiorMessage(
    username: string,
    taskName: string,
    taskUrl: string,
    deadline: Date,
    content: string
  ): FlexMessage {
    return {
      type: "flex",
      altText: `${ username }„Åï„Çì„Åã„Çâ„Äå${ taskName }„Äç„ÅÆÈÄ≤ÊçóÂÖ±Êúâ„Åå„ÅÇ„Çä„Åæ„Åó„ÅüÔºÅ`,
      contents: {
        type: "bubble",
        body: {
          type: "box",
          layout: "vertical",
          contents: [
            {
              type: "text",
              text: taskName,
              weight: "bold",
              size: "xl",
              wrap: true,
              action: { type: "uri", label: "„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞", uri: taskUrl },
            },
            {
              type: "box",
              layout: "vertical",
              margin: "lg",
              spacing: "sm",
              contents: [
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "sm",
                  contents: [
                    { type: "text", text: "ÊúüÈôê", color: "#BDBDBD", size: "sm", flex: 1 },
                    {
                      type: "text",
                      wrap: true,
                      color: "#666666",
                      size: "md",
                      flex: 4,
                      contents: [
                        { type: "span", text: "„ÅÇ„Åï„Å£„Å¶", weight: "bold", color: "#FFB300" },
                        { type: "span", text: `(${ getDate(deadline) })`, size: "sm" },
                      ],
                    },
                  ],
                },
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "sm",
                  contents: [
                    { type: "text", text: "ÊãÖÂΩìËÄÖ", color: "#BDBDBD", size: "sm", flex: 1 },
                    { type: "text", text: `${ username }„Åï„Çì`, color: "#666666", size: "md", flex: 4, wrap: true },
                  ],
                },
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "sm",
                  contents: [
                    { type: "text", text: "ÈÄ≤Êçó", color: "#BDBDBD", size: "sm", flex: 1 },
                    { type: "text", text: content, color: "#666666", size: "md", flex: 4, wrap: true },
                  ],
                },
              ],
            },
          ],
        },
      },
    };
  }

  static getTextContentFromMessage(message: Message): string {
    switch (message.type) {
      case "text":
        return message.text;

      case "flex":
        const texts = [];
        const findText = (components: FlexComponent[]) => {
          components.forEach(component => {
            switch (component.type) {
              case "text":
                if (component.text) {
                  texts.push(component.text);
                } else if (component.contents) {
                  findText(component.contents);
                }
                break;
              case "span":
                const lastText = texts.pop();
                texts.push(lastText + component.text);
                break;
              case "box":
                if (component.contents) {
                  findText(component.contents);
                }
                break;
              default:
                break;
            }
          });
        };

        const messageContents = message.contents;
        if (messageContents.type === "bubble") {
          const flexComponents = messageContents.body?.contents ?? [];
          findText(flexComponents);
        }
        return texts.join("\n");

      case "audio":
        return message.originalContentUrl;

      case "image":
        return message.originalContentUrl;

      case "imagemap":
        return message.baseUrl;

      case "location":
        return message.address;

      case "sticker":
        return message.packageId;

      case "template":
        return message.altText;

      case "video":
        return message.originalContentUrl;

      default:
        return "";
    }
  }

  static relativeRemindDays(remindDays: number): string {
    if (remindDays > 1) {
      return `${ remindDays.toString() }Êó•Ââç`;
    } else if (remindDays === 1) {
      return "Êò®Êó•";
    } else if (remindDays === 0) {
      return "‰ªäÊó•";
    } else if (remindDays === -1) {
      return "ÊòéÊó•";
    } else if (remindDays === -2) {
      return "„ÅÇ„Åï„Å£„Å¶";
    } else {
      return `${ (-remindDays).toString() }Êó•Âæå`;
    }
  }

  static getRemindColor(remindDays: number): string {
    return remindDays > 0 ? Colors.alert : Colors.warning;
  }
}
